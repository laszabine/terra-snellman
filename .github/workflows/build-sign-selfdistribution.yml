name: build & sign & publish
on:
  push:
    branches:
      - master
jobs:
  compare-version:
    name: Compare version
    runs-on: ubuntu-latest
    outputs:
      newVersion: ${{ steps.read-committed-version.outputs.newVersion }}
      isDifferent: ${{ steps.compare-version.outputs.isDifferent }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v1
        # uses: actions/checkout@master

      - name: "Open committed manifest"
        id: open-committed-manifest
        uses: juliangruber/read-file-action@v1
        with:
          path: "./manifest.json"

      - name: "Read committed version"
        id: read-committed-version
        run: echo "::set-output name=newVersion::v${{ fromJson(steps.open-committed-manifest.outputs.content).version }}"

      - name: "Read latest release version"
        id: read-latest-release-version
        uses: oprypin/find-latest-tag@v1
        with:
          repository: ${{ github.repository }}

      - name: "Compare version"
        id: compare-version
        run: |
          echo "Committed version is ${newVersion}, latest release version is ${oldVersion}"
          if [ ${newVersion} = ${oldVersion} ]; then
            echo "They are identical"
            echo "::set-output name=isDifferent::false"
          else
            echo "They are different"
            echo "::set-output name=isDifferent::true"
          fi
        env:
          newVersion: ${{ steps.read-committed-version.outputs.newVersion }}
          oldVersion: ${{ steps.read-latest-release-version.outputs.tag }}

  publish-to-github:
    name: Publish to Github
    needs: compare-version
    if: ${{ needs.compare-version.outputs.isDifferent }}
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v1

      - name: "Build"
        id: web-ext-build
        uses: kewisch/action-web-ext@v1
        with:
          cmd: build
          source: .

      - name: "Sign"
        id: web-ext-sign
        uses: kewisch/action-web-ext@v1
        with:
          cmd: sign
          source: ${{ steps.web-ext-build.outputs.target }}
          channel: unlisted
          apiKey: ${{ secrets.MOZILLA_API_SABINE_USER }}
          apiSecret: ${{ secrets.MOZILLA_API_SABINE_SECRET }}
        # uses: saphareas/sign-web-extension-action@master
        # with:
        #   web-ext-id: "{212d2e80-11e9-4876-a063-b544b093bb47}"
        #   sign-listed: false
        #   amo-api-key: ${{ secrets.MOZILLA_API_SABINE_USER }}
        #   amo-api-secret: ${{ secrets.MOZILLA_API_SABINE_SECRET }}

      - name: "Create Release"
        if: steps.web-ext-sign.conclusion == 'success' # must use single quotes for string literals
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.web-ext-sign.outputs.target }}
          tag_name: ${{ needs.compare-version.outputs.newVersion }}
          name: Release ${{ needs.compare-version.outputs.newVersion }}

#        uses: actions/create-release@v1
#          release_name: Release ${{ github.ref }}
#          tag_name: ${{ github.ref }}
#          draft: false
#          prerelease: true
        # if: SIGNING-WAS-SUCCESSFUL
        # if: startsWith(github.ref, 'refs/tags/')

#       - name: Upload Release Asset
#         id: upload-release-asset
#         uses: actions/upload-release-asset@v1
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         with:
#           upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
# #          asset_path: ./terra-snellman.zip
#           asset_name: terra-snellman.xpi
#           asset_content_type: application/zip
